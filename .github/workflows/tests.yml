name: Test Harpy Modules

on:
  push:
    branches:
      - 'main'
  pull_request:
    branches:
      - main

# Cancel in progress workflows on pull_requests.
# https://docs.github.com/en/actions/using-jobs/using-concurrency#example-using-a-fallback-value
concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

env:
  CACHE_NUMBER: 0  # increase to reset cache manually

jobs:
  changes:
    name: Detect File Changes
    runs-on: ubuntu-latest
      # Required permissions
    permissions:
      pull-requests: read
    # Set job outputs to values from filter step
    outputs:
      preflight: ${{ steps.filter.outputs.preflight }}
      deconvolve: ${{ steps.filter.outputs.deconvolve }}
      demux: ${{ steps.filter.outputs.demux }}
      qc: ${{ steps.filter.outputs.qc }}
      bwa: ${{ steps.filter.outputs.bwa }}
      ema: ${{ steps.filter.outputs.ema }}
      strobealign: ${{ steps.filter.outputs.strobealign }}
      mpileup: ${{ steps.filter.outputs.mpileup }}
      freebayes: ${{ steps.filter.outputs.freebayes }}
      leviathan: ${{ steps.filter.outputs.leviathan }}
      naibr: ${{ steps.filter.outputs.naibr }}
      impute: ${{ steps.filter.outputs.impute }}
      phase: ${{ steps.filter.outputs.phase }}
      simvars: ${{ steps.filter.outputs.simvars }}
      simreads: ${{ steps.filter.outputs.simreads }}
      other: ${{ steps.filter.outputs.other }}
      container: ${{ steps.filter.outputs.container }}
      modules: ${{ steps.filter.outputs.modules }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Check Which Files Have Changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          base: 'main'
          filters: .github/filters.yml

  pkgbuild:
    needs: changes
    name: Build/Cache Container
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Setup Mamba
        uses: mamba-org/setup-micromamba@v1
        with:
          init-shell: bash
          generate-run-shell: true
          environment-file: resources/harpy.yaml
          cache-environment: true
          post-cleanup: 'all'
      - name: Install Harpy
        shell: micromamba-shell {0}
        run: |
          python3 -m pip install --upgrade build && python3 -m build
          pip install dist/*.whl
          resources/buildforCI.sh
      - name: Clear Space
        run: rm -rf /opt/hostedtoolcache
      - name: Rebuild Dockerfile
        id: rebuild
        if: ${{ needs.changes.outputs.container == 'true' }}
        shell: micromamba-shell {0}
        run: harpy containerize
      - name: Set up Docker Buildx
        id: buildx
        if: ${{ steps.rebuild.outcome == 'success' }}
        uses: docker/setup-buildx-action@v3
      - name: Login to Docker Hub
        id: dockerhub
        if: ${{ steps.buildx.outcome == 'success' }}
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Build and Push to Dockerhub
        if: ${{ steps.dockerhub.outcome == 'success' }}
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: pdimens/harpy:latest
      - name: Pull Image Locally
        id: singularity
        shell: micromamba-shell {0}
        if: ${{ needs.changes.outputs.modules == 'true' }}
        run: harpy qc --skipreports --quiet test/fastq/sample1.*.fq.gz
      - name: Create Singularity Artifact
        if: ${{ steps.singularity.outcome == 'success' }}
        uses: actions/upload-artifact@v4
        with:
          name: deps-image
          path: .snakemake/singularity/*.simg
          retention-days: 1

  dmux_gen1:
    needs: [changes, pkgbuild]
    if: ${{ needs.changes.outputs.demux == 'true' && needs.pkgbuild.result == 'success' }}
    name: demux gen1
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Setup Mamba
        uses: mamba-org/setup-micromamba@v1
        with:
          init-shell: bash
          generate-run-shell: true
          environment-file: resources/harpy.yaml
          cache-environment: true
          post-cleanup: 'all'
      - name: Install Harpy
        shell: micromamba-shell {0}
        run: |
          python3 -m pip install --upgrade build && python3 -m build
          pip install dist/*.whl
          resources/buildforCI.sh
      - name: Clear Space
        run: rm -rf /opt/hostedtoolcache && mkdir -p .snakemake/singularity
      - name: Download Singularity Artifact
        uses: actions/download-artifact@v4
        with:
          name: deps-image
          path: .snakemake/singularity
      - name: harpy demultiplex
        shell: micromamba-shell {0}
        run: harpy demultiplex gen1 --quiet --schema test/demux/samples.schema test/demux/Undetermined_S0_L004_R* test/demux/Undetermined_S0_L004_I*

  preflight:
    needs: [changes, pkgbuild]
    if: ${{ needs.changes.outputs.preflight == 'true' && needs.pkgbuild.result == 'success' }}
    name: preflight
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Setup Mamba
        uses: mamba-org/setup-micromamba@v1
        env:
          ACTIONS_STEP_DEBUG: true
        with:
          init-shell: bash
          generate-run-shell: true
          environment-file: resources/harpy.yaml
          cache-environment: true
          post-cleanup: 'all'
          log-level: error
      - name: Install Harpy
        shell: micromamba-shell {0}
        run: |
          python3 -m pip install --upgrade build && python3 -m build
          pip install dist/*.whl
          resources/buildforCI.sh
      - name: Clear Space
        run: rm -rf /opt/hostedtoolcache && mkdir -p .snakemake/singularity
      - name: Download Singularity Artifact
        uses: actions/download-artifact@v4
        with:
          name: deps-image
          path: .snakemake/singularity
      - name: test preflight fastq
        shell: micromamba-shell {0}
        run: harpy preflight fastq test/fastq
      - name: test preflight bam
        if: always()
        shell: micromamba-shell {0}
        run: harpy preflight bam --quiet test/bam

  qc:
    needs: [changes, pkgbuild]
    if: ${{ needs.changes.outputs.qc == 'true' && needs.pkgbuild.result == 'success' }}
    name: qc
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Setup Mamba
        uses: mamba-org/setup-micromamba@v1
        env:
          ACTIONS_STEP_DEBUG: true
        with:
          init-shell: bash
          generate-run-shell: true
          environment-file: resources/harpy.yaml
          cache-environment: true
          post-cleanup: 'all'
          log-level: error
      - name: Install Harpy
        shell: micromamba-shell {0}
        run: |
          python3 -m pip install --upgrade build && python3 -m build
          pip install dist/*.whl
          resources/buildforCI.sh
      - name: Clear Space
        run: rm -rf /opt/hostedtoolcache && mkdir -p .snakemake/singularity
      - name: Download Singularity Artifact
        uses: actions/download-artifact@v4
        with:
          name: deps-image
          path: .snakemake/singularity
      - name: harpy qc
        shell: micromamba-shell {0}
        run: harpy qc -x "--trim_poly_g" --quiet test/fastq
      - name: harpy qc all options
        shell: micromamba-shell {0}
        run: harpy qc -a -d -c --quiet test/fastq
  deconvolve:
    needs: [changes, pkgbuild]
    if: ${{ needs.changes.outputs.deconvolve == 'true' && needs.pkgbuild.result == 'success' }}
    name: deconvolve
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Setup Mamba
        uses: mamba-org/setup-micromamba@v1
        env:
          ACTIONS_STEP_DEBUG: true
        with:
          init-shell: bash
          generate-run-shell: true
          environment-file: resources/harpy.yaml
          cache-environment: true
          post-cleanup: 'all'
          log-level: error
      - name: Install Harpy
        shell: micromamba-shell {0}
        run: |
          python3 -m pip install --upgrade build && python3 -m build
          pip install dist/*.whl
          resources/buildforCI.sh
      - name: Clear Space
        run: rm -rf /opt/hostedtoolcache && mkdir -p .snakemake/singularity
      - name: Download Singularity Artifact
        uses: actions/download-artifact@v4
        with:
          name: deps-image
          path: .snakemake/singularity
      - name: harpy deconvolve
        shell: micromamba-shell {0}
        run: harpy deconvolve --quiet test/fastq
  bwa:
    needs: [changes, pkgbuild]
    if: ${{ needs.changes.outputs.bwa == 'true' && needs.pkgbuild.result == 'success' }}
    name: align BWA
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Setup Mamba
        uses: mamba-org/setup-micromamba@v1
        env:
          ACTIONS_STEP_DEBUG: true
        with:
          init-shell: bash
          generate-run-shell: true
          environment-file: resources/harpy.yaml
          cache-environment: true
          post-cleanup: 'all'
          log-level: error
      - name: Install Harpy
        shell: micromamba-shell {0}
        run: |
          python3 -m pip install --upgrade build && python3 -m build
          pip install dist/*.whl
          resources/buildforCI.sh
      - name: Clear Space
        run: rm -rf /opt/hostedtoolcache && mkdir -p .snakemake/singularity
      - name: Download Singularity Artifact
        uses: actions/download-artifact@v4
        with:
          name: deps-image
          path: .snakemake/singularity
      - name: test bwa
        shell: micromamba-shell {0}
        run: harpy align bwa --quiet -g test/genome/genome.fasta.gz  -x "-A 2" test/fastq
  
  ema:
    needs: [changes, pkgbuild]
    if: ${{ needs.changes.outputs.ema == 'true' && needs.pkgbuild.result == 'success' }}
    name: align EMA
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Setup Mamba
        uses: mamba-org/setup-micromamba@v1
        env:
          ACTIONS_STEP_DEBUG: true
        with:
          init-shell: bash
          generate-run-shell: true
          environment-file: resources/harpy.yaml
          cache-environment: true
          post-cleanup: 'all'
          log-level: error
      - name: Install Harpy
        shell: micromamba-shell {0}
        run: |
          python3 -m pip install --upgrade build && python3 -m build
          pip install dist/*.whl
          resources/buildforCI.sh
      - name: Clear Space
        run: rm -rf /opt/hostedtoolcache && mkdir -p .snakemake/singularity
      - name: Download Singularity Artifact
        uses: actions/download-artifact@v4
        with:
          name: deps-image
          path: .snakemake/singularity
      - name: test ema
        shell: micromamba-shell {0}
        run: harpy align ema --quiet --ema-bins 150 -g test/genome/genome.fasta.gz -x "-d" test/fastq

  strobe:
    needs: [changes, pkgbuild]
    if: ${{ needs.changes.outputs.strobealign == 'true' && needs.pkgbuild.result == 'success' }}
    name: align strobe
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Setup Mamba
        uses: mamba-org/setup-micromamba@v1
        env:
          ACTIONS_STEP_DEBUG: true
        with:
          init-shell: bash
          generate-run-shell: true
          environment-file: resources/harpy.yaml
          cache-environment: true
          post-cleanup: 'all'
          log-level: error
      - name: Install Harpy
        shell: micromamba-shell {0}
        run: |
          python3 -m pip install --upgrade build && python3 -m build
          pip install dist/*.whl
          resources/buildforCI.sh
      - name: Clear Space
        run: rm -rf /opt/hostedtoolcache && mkdir -p .snakemake/singularity
      - name: Download Singularity Artifact
        uses: actions/download-artifact@v4
        with:
          name: deps-image
          path: .snakemake/singularity
      - name: test strobealign
        shell: micromamba-shell {0}
        run: harpy align strobe --quiet -l 125 -g test/genome/genome.fasta.gz  test/fastq

  mpileup:
    needs: [changes, pkgbuild]
    if: ${{ needs.changes.outputs.mpileup == 'true' && needs.pkgbuild.result == 'success' }}
    name: mpileup
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Setup Mamba
        uses: mamba-org/setup-micromamba@v1
        env:
          ACTIONS_STEP_DEBUG: true
        with:
          init-shell: bash
          generate-run-shell: true
          environment-file: resources/harpy.yaml
          cache-environment: true
          post-cleanup: 'all'
          log-level: error
      - name: Install Harpy
        shell: micromamba-shell {0}
        run: |
          python3 -m pip install --upgrade build && python3 -m build
          pip install dist/*.whl
          resources/buildforCI.sh
      - name: Clear Space
        run: rm -rf /opt/hostedtoolcache && mkdir -p .snakemake/singularity
      - name: Download Singularity Artifact
        uses: actions/download-artifact@v4
        with:
          name: deps-image
          path: .snakemake/singularity
      - name: snp mpileup
        shell: micromamba-shell {0}
        run: harpy snp mpileup --quiet -r test/positions.bed -g test/genome/genome.fasta.gz -x "--ignore-RG" test/bam
      - name: snp mpileup-pop
        shell: micromamba-shell {0}
        run: harpy snp mpileup --quiet -r test/positions.bed -o SNP/poptest -g test/genome/genome.fasta.gz -p test/samples.groups  test/bam
  
  freebayes:
    needs: [changes, pkgbuild]
    if: ${{ needs.changes.outputs.freebayes == 'true' && needs.pkgbuild.result == 'success' }}
    name: freebayes
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Setup Mamba
        uses: mamba-org/setup-micromamba@v1
        env:
          ACTIONS_STEP_DEBUG: true
        with:
          init-shell: bash
          generate-run-shell: true
          environment-file: resources/harpy.yaml
          cache-environment: true
          post-cleanup: 'all'
          log-level: error
      - name: Install Harpy
        shell: micromamba-shell {0}
        run: |
          python3 -m pip install --upgrade build && python3 -m build
          pip install dist/*.whl
          resources/buildforCI.sh
      - name: Clear Space
        run: rm -rf /opt/hostedtoolcache && mkdir -p .snakemake/singularity
      - name: Download Singularity Artifact
        uses: actions/download-artifact@v4
        with:
          name: deps-image
          path: .snakemake/singularity
      - name: snp freebayes
        shell: micromamba-shell {0}
        run: harpy snp freebayes --quiet -r test/positions.bed -g test/genome/genome.fasta.gz -x "-g 200" test/bam
      - name: snp freebayes-pop
        shell: micromamba-shell {0}
        run: harpy snp freebayes --quiet -r test/positions.bed -o SNP/poptest -g test/genome/genome.fasta.gz -p test/samples.groups  test/bam

  impute:
    needs: [changes, pkgbuild]
    if: ${{ needs.changes.outputs.impute == 'true' && needs.pkgbuild.result == 'success' }}
    name: impute
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Setup Mamba
        uses: mamba-org/setup-micromamba@v1
        env:
          ACTIONS_STEP_DEBUG: true
        with:
          init-shell: bash
          generate-run-shell: true
          environment-file: resources/harpy.yaml
          cache-environment: true
          post-cleanup: 'all'
          log-level: error
      - name: Install Harpy
        shell: micromamba-shell {0}
        run: |
          python3 -m pip install --upgrade build && python3 -m build
          pip install dist/*.whl
          resources/buildforCI.sh
      - name: Clear Space
        run: rm -rf /opt/hostedtoolcache && mkdir -p .snakemake/singularity
      - name: Download Singularity Artifact
        uses: actions/download-artifact@v4
        with:
          name: deps-image
          path: .snakemake/singularity
      - name: impute
        shell: micromamba-shell {0}
        run: harpy impute --quiet --vcf test/vcf/test.bcf -p test/stitch.params  test/bam
      - name: impute from vcf
        shell: micromamba-shell {0}
        if: always()
        run: harpy impute --quiet --vcf-samples -o vcfImpute --vcf test/vcf/test.bcf -p test/stitch.params  test/bam

  phase:
    needs: [changes, pkgbuild]
    if: ${{ needs.changes.outputs.phase == 'true' && needs.pkgbuild.result == 'success' }}
    name: phase
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Setup Mamba
        uses: mamba-org/setup-micromamba@v1
        env:
          ACTIONS_STEP_DEBUG: true
        with:
          init-shell: bash
          generate-run-shell: true
          environment-file: resources/harpy.yaml
          cache-environment: true
          post-cleanup: 'all'
          log-level: error
      - name: Install Harpy
        shell: micromamba-shell {0}
        run: |
          python3 -m pip install --upgrade build && python3 -m build
          pip install dist/*.whl
          resources/buildforCI.sh
      - name: Clear Space
        run: rm -rf /opt/hostedtoolcache && mkdir -p .snakemake/singularity
      - name: Download Singularity Artifact
        uses: actions/download-artifact@v4
        with:
          name: deps-image
          path: .snakemake/singularity
      - name: phase
        shell: micromamba-shell {0}
        run: harpy phase --quiet --vcf test/vcf/test.bcf  -x "--max_iter 10001" test/bam
      - name: phase with indels
        shell: micromamba-shell {0}
        if: always()
        run: harpy phase --quiet --vcf test/vcf/test.bcf -o phaseindel -g test/genome/genome.fasta.gz  test/bam
      - name: phase from vcf
        shell: micromamba-shell {0}
        if: always()
        run: |
          cp test/bam/sample1.bam test/bam/pineapple.bam && rename_bam -d test/bam/pineapple.bam pineapple1
          harpy phase --quiet --vcf-samples -o phasevcf --vcf test/vcf/test.bcf  test/bam

  leviathan:
    needs: [changes, pkgbuild]
    if: ${{ needs.changes.outputs.leviathan == 'true' && needs.pkgbuild.result == 'success' }}
    name: sv leviathan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Setup Mamba
        uses: mamba-org/setup-micromamba@v1
        env:
          ACTIONS_STEP_DEBUG: true
        with:
          init-shell: bash
          generate-run-shell: true
          environment-file: resources/harpy.yaml
          cache-environment: true
          post-cleanup: 'all'
          log-level: error
      - name: Install Harpy
        shell: micromamba-shell {0}
        run: |
          python3 -m pip install --upgrade build && python3 -m build
          pip install dist/*.whl
          resources/buildforCI.sh
      - name: Clear Space
        run: rm -rf /opt/hostedtoolcache && mkdir -p .snakemake/singularity
      - name: Download Singularity Artifact
        uses: actions/download-artifact@v4
        with:
          name: deps-image
          path: .snakemake/singularity
      - name: leviathan
        shell: micromamba-shell {0}
        run: harpy sv leviathan --quiet -s 100 -b 1 -g test/genome/genome.fasta.gz  -x "-M 2002" test/bam
        continue-on-error: true
      - name: leviathan-pop
        if: always()
        shell: micromamba-shell {0}
        run: harpy sv leviathan --quiet -s 100 -b 1 -g test/genome/genome.fasta.gz -o SV/leviathanpop -p test/samples.groups  test/bam

  naibr:
    needs: [changes, pkgbuild]
    if: ${{ needs.changes.outputs.naibr == 'true' && needs.pkgbuild.result == 'success' }}
    name: sv naibr
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Setup Mamba
        uses: mamba-org/setup-micromamba@v1
        env:
          ACTIONS_STEP_DEBUG: true
        with:
          init-shell: bash
          generate-run-shell: true
          environment-file: resources/harpy.yaml
          cache-environment: true
          post-cleanup: 'all'
          log-level: error
      - name: Install Harpy
        shell: micromamba-shell {0}
        run: |
          python3 -m pip install --upgrade build && python3 -m build
          pip install dist/*.whl
          resources/buildforCI.sh
      - name: Clear Space
        run: rm -rf /opt/hostedtoolcache && mkdir -p .snakemake/singularity
      - name: Download Singularity Artifact
        uses: actions/download-artifact@v4
        with:
          name: deps-image
          path: .snakemake/singularity
      - name: naibr
        shell: micromamba-shell {0}
        run: harpy sv naibr --quiet -g test/genome/genome.fasta.gz -o SV/naibr  -x "-min_sv 5000" test/bam_phased && rm -r Genome
      - name: naibr pop
        if: always()
        shell: micromamba-shell {0}
        run: harpy sv naibr --quiet -g test/genome/genome.fasta.gz -o SV/pop -p test/samples.groups  test/bam_phased && rm -r Genome
      - name: naibr with phasing
        if: always()
        shell: micromamba-shell {0}
        run: |
          harpy sv naibr --quiet -g test/genome/genome.fasta.gz -o SV/phase -v test/vcf/test.phased.bcf  test/bam && rm -r Genome
      - name: naibr pop with phasing
        if: always()
        shell: micromamba-shell {0}
        run: harpy sv naibr --quiet -g test/genome/genome.fasta.gz -o SV/phasepop -v test/vcf/test.phased.bcf -p test/samples.groups  test/bam && rm -r Genome


  simulate_variants:
    needs: [changes, pkgbuild]
    if: ${{ needs.changes.outputs.simvars == 'true' && needs.pkgbuild.result == 'success' }}
    name: simulate variants
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Setup Mamba
        uses: mamba-org/setup-micromamba@v1
        env:
          ACTIONS_STEP_DEBUG: true
        with:
          init-shell: bash
          generate-run-shell: true
          environment-file: resources/harpy.yaml
          cache-environment: true
          post-cleanup: 'all'
          log-level: error
      - name: Install Harpy
        shell: micromamba-shell {0}
        run: |
          python3 -m pip install --upgrade build && python3 -m build
          pip install dist/*.whl
          resources/buildforCI.sh
      - name: Clear Space
        run: rm -rf /opt/hostedtoolcache && mkdir -p .snakemake/singularity
      - name: Download Singularity Artifact
        uses: actions/download-artifact@v4
        with:
          name: deps-image
          path: .snakemake/singularity
      - name: simulate random snps/indels
        shell: micromamba-shell {0}
        run: |
          harpy simulate snpindel --quiet --snp-count 10 --indel-count 10 -z 0.5  test/genome/genome.fasta.gz
          harpy simulate snpindel --quiet --prefix Simulate/snpvcf --snp-vcf Simulate/snpindel/diploid/sim.snpindel.snp.hap1.vcf --indel-vcf Simulate/snpindel/diploid/sim.snpindel.indel.hap1.vcf  test/genome/genome.fasta.gz
      - name: simulate inversions
        shell: micromamba-shell {0}
        if: always()
        run: |
          harpy simulate inversion --quiet --count 10 -z 0.5 test/genome/genome.fasta.gz
          harpy simulate inversion --quiet --prefix Simulate/invvcf --vcf Simulate/inversion/diploid/sim.inversion.hap1.vcf  test/genome/genome.fasta.gz
      - name: simulate cnv
        shell: micromamba-shell {0}
        if: always()
        run: |
          harpy simulate cnv --quiet --count 10 -z 0.5 test/genome/genome.fasta.gz
          harpy simulate cnv --quiet --prefix Simulate/cnvvcf --vcf Simulate/cnv/diploid/sim.cnv.hap1.vcf  test/genome/genome.fasta.gz
      - name: simulate translocations
        shell: micromamba-shell {0}
        if: always()
        run: |
          harpy simulate translocation --quiet --count 10 -z 0.5 test/genome/genome.fasta.gz
          harpy simulate translocation --quiet --prefix Simulate/transvcf --vcf Simulate/translocation/diploid/sim.translocation.hap1.vcf  test/genome/genome.fasta.gz

  simulate_linkedreads:
    needs: [changes, pkgbuild]
    if: ${{ needs.changes.outputs.simreads == 'true' && needs.pkgbuild.result == 'success' }}
    name: simulate linkedreads
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Setup Mamba
        uses: mamba-org/setup-micromamba@v1
        env:
          ACTIONS_STEP_DEBUG: true
        with:
          init-shell: bash
          generate-run-shell: true
          environment-file: resources/harpy.yaml
          cache-environment: true
          post-cleanup: 'all'
          log-level: error
      - name: Install Harpy
        shell: micromamba-shell {0}
        run: |
          python3 -m pip install --upgrade build && python3 -m build
          pip install dist/*.whl
          resources/buildforCI.sh
      - name: Clear Space
        run: rm -rf /opt/hostedtoolcache && mkdir -p .snakemake/singularity
      - name: Download Singularity Artifact
        uses: actions/download-artifact@v4
        with:
          name: deps-image
          path: .snakemake/singularity
      - name: simulate linked reads
        shell: micromamba-shell {0}
        run: harpy simulate linkedreads --quiet -t 4 -n 2  -l 100 -p 50 test/genome/genome.fasta.gz test/genome/genome2.fasta.gz

  extras:
    needs: [changes, pkgbuild]
    if: ${{ needs.changes.outputs.other == 'true' && needs.pkgbuild.result == 'success' }}
    name: harpy extras
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Setup Mamba
        uses: mamba-org/setup-micromamba@v1
        env:
          ACTIONS_STEP_DEBUG: true
        with:
          init-shell: bash
          generate-run-shell: true
          environment-file: resources/harpy.yaml
          cache-environment: true
          post-cleanup: 'all'
          log-level: error
      - name: Install Harpy
        shell: micromamba-shell {0}
        run: |
          python3 -m pip install --upgrade build && python3 -m build
          pip install dist/*.whl
          resources/buildforCI.sh
      - name: Clear Space
        run: rm -rf /opt/hostedtoolcache && mkdir -p .snakemake/singularity
      - name: harpy stitchparams
        shell: micromamba-shell {0}
        run: harpy stitchparams -o params.file
      - name: harpy popgroup
        shell: micromamba-shell {0}
        run: harpy popgroup test/fastq
      - name: harpy hpc
        shell: micromamba-shell {0}
        run: |
          harpy hpc slurm
          harpy hpc googlebatch
          harpy hpc lsf
          harpy hpc htcondor